name: build-and-test

on: push

jobs:
  build:
    name: "Build pylib on Debian"
    runs-on: ubuntu-latest
    container: debian:trixie
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Install build tools
        run: |
          apt update
          apt install -y git cmake ninja-build g++-mingw-w64-x86-64 gcc-mingw-w64-x86-64 wget curl mono-devel
          wget --no-check-certificate https://dist.nuget.org/win-x86-commandline/latest/nuget.exe
          chmod +x nuget.exe
          mono nuget.exe install python -Version 3.13.0
      - name: Execute build
        run: |
          ls -l
          cmake --preset mingw-release
          cmake --build --preset mingw-release --target install
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            build/mingw-release/install
            python.3.13.0
  test:
    name: "Run tests on Windows"
    runs-on: windows-latest
    needs: build

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
      - name: Execute tests
        run: |
          dir
          $Env:PATH = "$PWD/python.3.13.0/tools;$Env:PATH"
          cd build/mingw-release/install
          bin/tests.exe
          python --version
          python -m venv venv
          venv/Scripts/activate
          pip install numpy pytest
          pytest --junitxml pytest_result.xml
